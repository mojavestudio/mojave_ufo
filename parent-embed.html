<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mojave UFO – Parent Embed Test</title>
</head>
<body>
  <div id="ufo-wrap" style="position:relative;width:100%;min-height:1px;">
    <div id="ufo-sticky" style="position:sticky;top:0;width:100%;height:1px;"></div>
    <div id="ufo-slot" style="position:absolute;inset:0;"></div>

    <script>
      (function () {
        const wrap   = document.getElementById('ufo-wrap');
        const sticky = document.getElementById('ufo-sticky');
        const slot   = document.getElementById('ufo-slot');

        // Lock to real visual viewport in px
        const vpH = () => Math.round((window.visualViewport?.height || window.innerHeight) || 0);
        function lock(force) {
          const h = vpH();
          if (force || h) {
            sticky.style.height = h + 'px';
            wrap.style.height   = h + 'px';
          }
        }
        lock(true);
        addEventListener('resize', () => lock(false), { passive: true });
        visualViewport?.addEventListener('resize', () => lock(false), { passive: true });
        addEventListener('orientationchange', () => lock(true), { passive: true });

        // Create the iframe only after wrapper is non-zero for 2 consecutive frames
        let stable = 0, created = false;
        const ro = new ResizeObserver(([entry]) => {
          const { width, height } = entry.contentRect;
          if (width > 0 && height > 0) stable++; else stable = 0;
          if (!created && stable >= 2) {
            created = true;
            const ifr = document.createElement('iframe');
            ifr.allow = 'xr-spatial-tracking; fullscreen; gyroscope; accelerometer';
            ifr.loading = 'eager';
            ifr.scrolling = 'no';
            ifr.style.cssText = 'border:0;position:absolute;inset:0;width:100%;height:100%;display:block;'
              + 'max-width:none;box-sizing:border-box;overflow:hidden;';
            // Point to the MOBILE repo with external sync enabled
            ifr.src = 'https://mojavestudio.github.io/UFO-mobile/?external=1&scrollvh=170&v=9';
            slot.appendChild(ifr);
            ro.disconnect();

            // --- Parent ↔ child scroll sync bridge ---
            function maxScroll(){
              return Math.max(0, document.documentElement.scrollHeight - window.innerHeight);
            }
            function sendRange(){
              try { ifr.contentWindow?.postMessage({ type: 'SCROLL_RANGE', rangePx: maxScroll() }, '*'); } catch {}
            }
            function sendProgress(){
              const max = maxScroll();
              const progress = max > 0 ? (document.documentElement.scrollTop / max) : 0;
              try { ifr.contentWindow?.postMessage({ type: 'SCROLL_PROGRESS', progress }, '*'); } catch {}
            }

            // Respond when the child says hello
            addEventListener('message', (e) => {
              const d = e?.data; if (!d) return;
              if (d.type === 'HELLO_FROM_CHILD') {
                sendRange();
                sendProgress();
              }
            });

            // Keep the child updated as the parent layout changes
            const notify = () => { sendRange(); sendProgress(); }
            addEventListener('scroll', sendProgress, { passive: true });
            addEventListener('resize', notify, { passive: true });
            visualViewport?.addEventListener('resize', notify, { passive: true });
          }
        });
        ro.observe(wrap);
      })();
    </script>
  </div>
</body>
</html>


