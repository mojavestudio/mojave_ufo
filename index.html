<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- fixed zoom; consistent wheel/touch in embeds -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Mojave UFO</title>

  <!-- Self-hosted Spline viewer -->
  <script type="module" src="./vendor/spline-viewer/build/spline-viewer.js"></script>

<style>
  /* Child defaults: allow standalone testing; external mode will force overflow hidden via script */
  html, body { margin: 0; height: 100%; background: transparent; }
  #wrap { position: absolute; inset: 0; }
  spline-viewer { display: block; width: 100%; height: 100%; pointer-events: none; }
</style>
</head>
<body>
  <div id="wrap">
    <!-- IMPORTANT: events-target="global" for current viewer builds -->
    <spline-viewer id="sv" url="./scene.splinecode" events-target="global" intercept-scroll="false" unloadable="false" loading-anim="true"></spline-viewer>
  </div>

  <script>
  (function () {
    const sv = document.getElementById('sv');
    const html = document.documentElement;
    const body = document.body;
    const q  = new URLSearchParams(location.search);

    // Consider embedded if in iframe OR explicit param
    let embedded = false;
    try { embedded = window.self !== window.top; } catch { embedded = true; }
    const external = embedded || q.get('external') === '1' || q.get('external') === 'true';

    // External mode: paint-only. No internal scroll.
    if (external) {
      html.style.overflow = 'hidden';
      body.style.overflow = 'hidden';
    }

    // READY handshake to parent (beat races)
    const ping = () => { try { parent.postMessage({ type:'SPLINE_IFRAME_READY' }, '*'); } catch {} };
    ping();
    window.addEventListener('DOMContentLoaded', ping);
    window.addEventListener('load', ping);
    sv?.addEventListener?.('load', ping);
    sv?.addEventListener?.('load-complete', ping);
    // a few delayed pings
    setTimeout(ping, 150);
    setTimeout(ping, 450);

    // Receive normalized progress 0..1 from parent
    window.addEventListener('message', (e) => {
      const d = e?.data;
      if (!d || typeof d !== 'object') return;
      if (d.type === 'FRAMER_SCROLL_PROGRESS' && typeof d.progress === 'number') {
        const t = Math.min(1, Math.max(0, d.progress));
        try { sv.setTime?.(t); } catch {}
      }
    });

    // Minimal standalone fallback
    if (!external) {
      const ghost = document.createElement('div');
      ghost.style.cssText = 'height:120vh; visibility:hidden; pointer-events:none;';
      body.appendChild(ghost);

      function drive() {
        const max = Math.max(1, html.scrollHeight - html.clientHeight);
        const t   = Math.min(1, Math.max(0, html.scrollTop / max));
        try { sv.setTime?.(t); } catch {}
        if (t >= 1) ghost.style.height = (html.scrollTop + 1) + 'px';
      }
      window.addEventListener('scroll', drive, { passive: true });
      window.addEventListener('resize', drive);
      drive();
    }
  })();
  </script>
</body>
</html>
