<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1"
  />
  <title>Mojave UFO</title>
  <!-- CSS units fixed: 100vw/100svh (no spaces) -->

  <!-- Use your pinned viewer; do NOT load another viewer anywhere else -->
  <script>if (!window.THREE) window.THREE = {};</script>  <!-- Guard against multiple Three.js -->
  <script type="module" src="./vendor/spline-viewer/build/spline-viewer.js"></script>

</head>
<body>
  <!-- place this <style> anywhere in the BODY (not head) -->
  <style>
    html, body { margin:0; height:100%; background:transparent; }
    /* full-bleed sticky section */
    #outer  { position: relative; width: 100vw; }
    #sticky { position: sticky; top: 0; width: 100vw; height: 100svh; }
    /* viewer fills the viewport */
    spline-viewer {
      display:block !important;
      width:100vw !important;
      height:100svh !important;
      max-width:none !important;
      min-width:0 !important;
    }
    /* hide scrollbar UI (keep scroll API functional) */
    html { scrollbar-width: none; }
    ::-webkit-scrollbar { width:0; height:0; }
  </style>

  <section id="outer">
    <div id="sticky">
      <div class="cover" id="cover">
        <spline-viewer
          id="viewer"
          events-target="local"
          loading="eager"
          style="display:block;width:100%;height:100%"
        ></spline-viewer>
      </div>
    </div>
  </section>

  <script type="module">
    // Ensure viewer custom element is available (safe if already loaded)
    import "https://unpkg.com/@splinetool/viewer@latest/build/spline-viewer.js";

    const qp       = new URLSearchParams(location.search);
    const isEmbed  = qp.get('external') === '1';
    const viewer   = document.getElementById('viewer');
    const outer    = document.getElementById('outer');

    // --- Never request a missing tablet file: pick what exists ---
    async function pickScene() {
      const candidates = [
        "scene.splinecode",
        "scene-desktop.splinecode",
        "scene-mobile.splinecode"
      ];
      for (const path of candidates) {
        try {
          const r = await fetch(path, { method:"HEAD", cache:"no-store" });
          if (r.ok) return path;
        } catch {}
      }
      return null;
    }

    // --- Only create fallback height when NOT embedded ---
    function applyFallbackHeight() {
      const px = parseInt(qp.get('scrollpx') || '0', 10);
      if (px) {
        outer.style.height = px + 'px';
      } else {
        const vh   = parseFloat(qp.get('scrollvh') || '170');
        const unit = (window.visualViewport?.height || window.innerHeight || 1) / 100;
        outer.style.height = (vh * unit) + 'px';
      }
    }
    if (!isEmbed) applyFallbackHeight();

    // --- Parent â†” Child handshake & scroll sync ---
    // Tell the parent "I'm ready" (Framer will attach to THIS iframe)
    function hello() {
      try { window.parent.postMessage({ type: "UFO_HELLO" }, "*"); } catch {}
    }
    hello();                    // initial ping
    window.addEventListener('load', hello); // ping again after load

    // Receive scroll range + progress from parent
    let lastRange = null;
    window.addEventListener('message', (e) => {
      const d = e.data || {};
      if (d.type === 'SCROLL_RANGE' && typeof d.rangePx === 'number') {
        lastRange = d.rangePx;
        // Make our outer height match the parent's driving range + 1 viewport
        outer.style.height = (lastRange + (window.innerHeight || 0)) + 'px';
      }
      if (d.type === 'SCROLL_PROGRESS' && typeof d.progress === 'number') {
        // Drive our internal scroll position (what your lockSticky uses)
        const max = Math.max(0, (document.documentElement.scrollHeight - window.innerHeight));
        document.documentElement.scrollTop = d.progress * max;
      }
    }, { passive: true });

    // --- Load a valid scene and render ---
    (async () => {
      const url = await pickScene();
      if (url) viewer.setAttribute('url', url);
    })();
  </script>
  
</body>
</html>
