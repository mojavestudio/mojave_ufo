<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mojave UFO</title>
  <!-- Self-hosted viewer -->
  <script type="module" src="./vendor/spline-viewer/build/spline-viewer.js"></script>
  <style>
    html, body { margin: 0; padding: 0; background: transparent; }
    /* Pin the viewer; let the PAGE (not a full-screen absolute div) be the scroller */
    #pin { position: sticky; top: 0; height: 100vh; }
    spline-viewer { display: block; width: 100%; height: 100%; }
    /* Real scroll height lives HERE (outside the pinned container) */
    #spacer { height: 2000px; }
  </style>
</head>
<body>
  <div id="pin">
    <!-- Listen on the iframe window -->
    <spline-viewer id="sv" url="./scene.splinecode" events-target="global" loading-anim="true"></spline-viewer>
  </div>
  <!-- Must be OUTSIDE #pin so it affects document height -->
  <div id="spacer" aria-hidden="true"></div>

  <script>
    (function () {
      const params   = new URLSearchParams(location.search);
      const scrollpx = Math.max(0, parseInt(params.get('scrollpx') || '2000', 10));
      const external = params.has('external'); // ?external=1 turns on bridge

      // Make the iframe page tall so programmatic scroll means something
      const spacer = document.getElementById('spacer');
      if (spacer) spacer.style.height = scrollpx + 'px';

      // If parent is driving progress, listen for its messages and set our scrollTop
      if (external) {
        const doc = document.scrollingElement || document.documentElement;
        const sv  = document.getElementById('sv');
        window.addEventListener('message', (e) => {
          const d = e && e.data || {};
          if (d.type !== 'SCROLL_PROGRESS') return;
          const p   = Math.max(0, Math.min(1, Number(d.progress) || 0));
          const max = Math.max(0, doc.scrollHeight - window.innerHeight);
          doc.scrollTop = p * max;
          // Nudge Spline listeners; also scrub timeline so timeline-only scenes sync
          try { window.dispatchEvent(new Event('scroll')); } catch {}
          try { const dur = Number(sv?.duration || 1); sv.setTime?.(p * dur); sv.play?.(); } catch {}
        }, { passive: true });
      }

      // Safety: if viewer never registers, the script didn't load
      setTimeout(() => {
        if (!customElements.get('spline-viewer')) console.warn('spline-viewer not registered â€” check script path or CSP');
      }, 4000);
    })();
  </script>
</body>
</html>
